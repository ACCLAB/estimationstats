{% extends "layouts/layout.html" %}

{% block title %}Home{% endblock %}

{% block content %}
  <div class="container">
    <h5>&nbsp;</h5>
    <form id="upload-file" action="#" enctype="multipart/form-data">
      <div class="file-field input-field">
        <div class="btn">
          <span>File</span>
          <input id="file-id" type="file" name="file" accept=".csv">
        </div>
        <div class="file-path-wrapper">
          <input id="file-path" class="file-path validate" type="text">
        </div>
        <div class="file-upload">
          <a id="upload-file-btn" class="waves-effect waves-light"><i class="medium material-icons dp48">file_upload</i></a>
        </div>
      </div>
    </form>
    <div id="plot_container">
      <div class="file-download">
        <a id="download-file-btn" class="waves-effect waves-light"><i class="medium material-icons dp48">file_download</i></a>
      </div>
    </div>
    <div>
      <div class="progress loader">
          <div class="indeterminate"></div>
      </div>
    </div>
  </div>
  <div class="modal-overlay"></div>
{% endblock %}

{% block scripts %}
  {{ super()}}
  <script type="text/javascript">
    var file, img;
    $(function () {
        var uploadFile = function (file) {
          // Show loader
          $('.modal-overlay').show();
          $('.loader').show();

          // Create formdata
          var form_data = new FormData(document.getElementById('upload-file'));
          form_data.append('file', file);
          var form = document.getElementById('upload-file');
          var formData = new FormData(form);
          $.ajax({
              type: 'POST',
              url: '/upload',
              data: form_data,
              contentType: false,
              cache: false,
              processData: false,
              async: true,
              success: function (data) {
                  $('#plot_container img').remove();
                  var $plot = $('<img>');
                  img = 'data:image/png;base64,' + data;
                  $plot.attr('src', img);
                  $plot.appendTo($('#plot_container'))
              },
              complete: function () {
                  // Hide loader
                  $('.modal-overlay').hide();
                  $('.loader').hide();
              }
          });
        };

        $('#upload-file-btn').click(function () {
            file = $('#file-id')[0].files[0];
            if (file) {
              var fileExtension = file.name.split('.').pop();
              if (fileExtension === 'csv') {
                  uploadFile(file);
              }
            }
        });

        $('#download-file-btn').click(function () {
            if (file && img) {
              var link = document.createElement('a');
              link.setAttribute('href', img);
              link.setAttribute('download', file.name.replace('.csv', '.png'));
              link.click();
            }
        });
    });
  </script>
{% endblock %}
